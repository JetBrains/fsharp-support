namespace JetBrains.ReSharper.Plugins.FSharp.Tests.Features

open JetBrains.ProjectModel
open JetBrains.ReSharper.Plugins.FSharp.Tests
open JetBrains.ReSharper.Plugins.FSharp.Util.FSharpAssemblyUtil
open JetBrains.ReSharper.Psi
open JetBrains.ReSharper.Psi.Impl.Reflection2
open JetBrains.ReSharper.Psi.Modules
open JetBrains.ReSharper.Resources.Shell
open JetBrains.ReSharper.TestFramework
open NUnit.Framework

[<FSharpTest>]
type FSharpAssemblyAutoOpenTest() =
    inherit FSharpReferencedAssemblyTestBase()

    override x.RelativeTestDataPath = "common/assemblyAutoOpens"

    override x.DoTest(assemblyPsiModule: IPsiModule) =
        let assemblyPsiModule = assemblyPsiModule :?> IAssemblyPsiModule
        let assemblyFileLoader = assemblyPsiModule.GetSolution().GetComponent<IPsiAssemblyFileLoader>()

        use cookie = ReadLockCookie.Create()
        x.ExecuteWithGold(fun writer ->
            for declaredElement in getAutoOpenModules assemblyFileLoader assemblyPsiModule.Assembly do
                match declaredElement with
                | :? INamespace as ns -> writer.WriteLine(ns.QualifiedName)
                | :? ITypeElement as typeElement -> writer.WriteLine(typeElement.GetClrName())
                | _ -> failwithf "Unexpected element: %O" declaredElement) |> ignore

    [<Test; TestPackages("FSharp.Core")>]
    member x.FSharpCore() = x.DoTest("FSharp.Core")
